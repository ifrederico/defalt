<!DOCTYPE html>
<html lang="{{@site.locale}}">
<head>

    {{!-- Basic meta - advanced meta is output with {{ghost_head}} below --}}
    <title>{{meta_title}}</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    {{!-- Favicon --}}
    <link rel="icon" type="image/svg+xml" href="{{asset "images/favicon.svg"}}">
     
    {{!-- Preload main styles and scripts for better performance --}}
    <link rel="preload" as="style" href="{{asset "built/screen.css"}}">
    <link rel="preload" as="script" href="{{asset "built/source.js"}}">
    
    {{!-- Fonts are preloaded and defined in the default template to avoid layout shift --}}
    {{> "typography/fonts"}}

    {{!-- Theme assets - use the {{asset}} helper to reference styles & scripts, this will take care of caching and cache-busting automatically --}}
    <link rel="stylesheet" type="text/css" href="{{asset "built/screen.css"}}">
    <link rel="stylesheet" type="text/css" href="{{asset "css/util.css"}}">

    {{!-- Custom background color --}}
    <style>
        :root {
            --background-color: {{@custom.site_background_color}}
        }
        [data-theme="dark"] {
            --background-color: #0f0f0f;
        }
    </style>

    <script>
        (function() {
            /* Dark mode initialization - runs early to prevent flash */
            var themeKey = 'themePreference';
            var legacyThemeKey = 'theme';
            var contrastKey = 'themeContrast';
            var mediaQuery = window.matchMedia('(prefers-color-scheme: dark)');
            var themeState = 'system';

            function readStorage(key) {
                try {
                    return localStorage.getItem(key);
                } catch (e) {
                    return null;
                }
            }

            function writeStorage(key, value) {
                try {
                    value ? localStorage.setItem(key, value) : localStorage.removeItem(key);
                } catch (e) {
                    /* ignore storage errors */
                }
            }

            function readStoredState() {
                var stored = readStorage(themeKey) || readStorage(legacyThemeKey);
                return stored === 'light' || stored === 'dark' ? stored : 'system';
            }

            function writeStoredState(state) {
                if (state === 'light' || state === 'dark') {
                    writeStorage(themeKey, state);
                } else {
                    writeStorage(themeKey, null);
                }
                writeStorage(legacyThemeKey, null);
            }

            function systemTheme() {
                return mediaQuery.matches ? 'dark' : 'light';
            }

            function resolveTheme(state) {
                if (state === 'light' || state === 'dark') {
                    return state;
                }
                return systemTheme();
            }

            function syncToggleUi(state, theme) {
                var pressed = state === 'dark' ? 'true' : state === 'light' ? 'false' : 'mixed';
                var label = state === 'system' ? 'Theme: System (' + theme + ')' : 'Theme: ' + state.charAt(0).toUpperCase() + state.slice(1);

                document.querySelectorAll('[data-theme-toggle]').forEach(function(btn) {
                    btn.setAttribute('aria-pressed', pressed);
                    btn.setAttribute('aria-label', label);
                    btn.setAttribute('data-theme-state', state);
                });

                document.querySelectorAll('[data-theme-option]').forEach(function(option) {
                    var value = option.getAttribute('data-theme-option');
                    var isActive = value === state;
                    option.classList.toggle('is-active', isActive);
                    option.setAttribute('aria-checked', isActive ? 'true' : 'false');
                });
            }

            function applyState(state, persist) {
                var theme = resolveTheme(state);
                themeState = state;

                document.documentElement.setAttribute('data-theme', theme);
                document.documentElement.setAttribute('data-theme-mode', state);
                syncToggleUi(state, theme);

                if (persist === true) {
                    writeStoredState(state);
                } else if (state === 'system') {
                    writeStoredState(null);
                }
            }

            var storedState = readStoredState();
            applyState(storedState, storedState !== 'system');

            function handleSystemChange(event) {
                if (themeState === 'system') {
                    applyState('system', false);
                }
            }

            if (typeof mediaQuery.addEventListener === 'function') {
                mediaQuery.addEventListener('change', handleSystemChange);
            } else if (typeof mediaQuery.addListener === 'function') {
                mediaQuery.addListener(handleSystemChange);
            }

            function cycleThemeMode() {
                var nextState = themeState === 'system' ? 'light' : themeState === 'light' ? 'dark' : 'system';
                applyState(nextState, nextState !== 'system');
            }

            window.cycleThemeMode = cycleThemeMode;

            function syncAfterDomReady() {
                syncToggleUi(themeState, resolveTheme(themeState));
            }

            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', syncAfterDomReady);
            } else {
                syncAfterDomReady();
            }

            function closeThemeMenus() {
                document.querySelectorAll('[data-theme-menu]').forEach(function(menu) {
                    menu.hidden = true;
                    menu.classList.remove('is-open');
                });
                document.querySelectorAll('[data-theme-toggle]').forEach(function(btn) {
                    btn.setAttribute('aria-expanded', 'false');
                });
            }

            function openThemeMenu(toggle, menu) {
                closeThemeMenus();
                if (menu) {
                    menu.hidden = false;
                    menu.classList.add('is-open');
                    toggle.setAttribute('aria-expanded', 'true');
                }
            }

            document.addEventListener('click', function(evt) {
                var option = evt.target.closest('[data-theme-option]');
                if (option) {
                    evt.preventDefault();
                    var state = option.getAttribute('data-theme-option');
                    applyState(state, state !== 'system');
                    closeThemeMenus();
                    return;
                }

                var toggle = evt.target.closest('[data-theme-toggle]');
                if (toggle) {
                    evt.preventDefault();
                    var menu = toggle.closest('.gh-theme-control')?.querySelector('[data-theme-menu]');
                    var expanded = toggle.getAttribute('aria-expanded') === 'true';
                    expanded ? closeThemeMenus() : openThemeMenu(toggle, menu);
                    return;
                }

                closeThemeMenus();
            });

            function readCachedContrast(color) {
                var cached = readStorage(contrastKey);
                if (!cached) return null;
                try {
                    var parsed = JSON.parse(cached);
                    if (parsed && parsed.color === color && parsed.tone) {
                        return parsed.tone;
                    }
                } catch (e) {
                    return null;
                }
                return null;
            }

            function writeCachedContrast(color, tone) {
                try {
                    writeStorage(contrastKey, JSON.stringify({ color: color, tone: tone }));
                } catch (e) {
                    /* ignore storage errors */
                }
            }

            /* The script for calculating the color contrast has been taken from
            https://gomakethings.com/dynamically-changing-the-text-color-based-on-background-color-contrast-with-vanilla-js/ */
            var accentColor = getComputedStyle(document.documentElement).getPropertyValue('--background-color').trim();
            var cachedTone = readCachedContrast(accentColor);

            if (!cachedTone) {
                var normalized = accentColor.charAt(0) === '#' ? accentColor.slice(1) : accentColor;

                if (normalized.length === 3) {
                    normalized = normalized[0] + normalized[0] + normalized[1] + normalized[1] + normalized[2] + normalized[2];
                }

                if (normalized.length === 6) {
                    var r = parseInt(normalized.substr(0, 2), 16);
                    var g = parseInt(normalized.substr(2, 2), 16);
                    var b = parseInt(normalized.substr(4, 2), 16);
                    var yiq = ((r * 299) + (g * 587) + (b * 114)) / 1000;
                    cachedTone = (yiq >= 128) ? 'dark' : 'light';
                } else {
                    cachedTone = 'dark';
                }
                writeCachedContrast(accentColor, cachedTone);
            }

            if (document.documentElement.getAttribute('data-theme') !== 'dark') {
                document.documentElement.classList.add(`has-${cachedTone}-text`);
            }
        })();
    </script>

    {{!-- This tag outputs all your advanced SEO meta, structured data, and other important settings, it should always be the last tag before the closing head tag --}}
    {{ghost_head}}

</head>
<body class="{{body_class}} has-{{#match @custom.title_font "Elegant serif"}}serif{{else match @custom.title_font "Consistent mono"}}mono{{else}}sans{{/match}}-title has-{{#match @custom.body_font "Elegant serif"}}serif{{else}}sans{{/match}}-body">

<div class="gh-viewport">
    
    {{> "components/navigation" navigationLayout=@custom.navigation_layout}}

    {{{body}}}
    
    {{> "components/footer"}}
    
</div>

{{#is "post, page"}}
    {{> "lightbox"}}
{{/is}}

{{!-- Scripts - handle responsive videos, infinite scroll, and navigation dropdowns --}}
<script src="{{asset "built/source.js"}}"></script>
<script src="{{asset "custom/utils.js"}}"></script>

{{!-- Ghost outputs required functional scripts with this tag, it should always be the last thing before the closing body tag --}}
{{ghost_foot}}

</body>
</html>
